#!/bin/bash

# Script to install Traefik BlockIP plugin
set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

PLUGIN_NAME="traefik-plugin-blockip"
TRAEFIK_PLUGINS_DIR="${TRAEFIK_PLUGINS_DIR:-. }"
PLUGIN_VERSION="${PLUGIN_VERSION:-2.0.0}"

echo -e "${YELLOW}Installing Traefik BlockIP Plugin${NC}"
echo "Plugin Directory: $TRAEFIK_PLUGINS_DIR"
echo ""

# Build the plugin
echo -e "${YELLOW}Step 1: Building plugin...${NC}"
go build -v -o "$PLUGIN_NAME" . 
if [ $? -ne 0 ]; then
    echo -e "${RED}✗ Build failed${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Plugin built successfully${NC}"

# Create plugin directory if it doesn't exist
PLUGIN_PATH="$TRAEFIK_PLUGINS_DIR/local/$PLUGIN_NAME/$PLUGIN_VERSION"
echo -e "${YELLOW}Step 2: Creating plugin directory...${NC}"
mkdir -p "$PLUGIN_PATH"
echo -e "${GREEN}✓ Directory created: $PLUGIN_PATH${NC}"

# Copy plugin files
echo -e "${YELLOW}Step 3: Copying plugin files...${NC}"
cp "$PLUGIN_NAME" "$PLUGIN_PATH/" 
cp ". traefik.yml" "$PLUGIN_PATH/"
cp "manifest.yaml" "$PLUGIN_PATH/"
echo -e "${GREEN}✓ Files copied${NC}"

# Verify installation
echo -e "${YELLOW}Step 4: Verifying installation...${NC}"
if [ -f "$PLUGIN_PATH/$PLUGIN_NAME" ]; then
    echo -e "${GREEN}✓ Plugin installed successfully${NC}"
    ls -lh "$PLUGIN_PATH"
else
    echo -e "${RED}✗ Installation verification failed${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}Installation complete!${NC}"
echo "Plugin location: $PLUGIN_PATH"